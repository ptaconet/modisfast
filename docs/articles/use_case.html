<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>3. Full use case • modisfast</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="3. Full use case">
<meta property="og:description" content="modisfast">
<meta property="og:image" content="/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">modisfast</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.1.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/get_started.html">1. Get started </a>
    </li>
    <li>
      <a href="../articles/modisfast2.html">2. Get data on several regions or periods of interest at a glance</a>
    </li>
    <li>
      <a href="../articles/use_case.html">3. Full use case</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/ptaconet/modisfast/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>3. Full use case</h1>
                        <h4 data-toc-skip class="author">Paul
Taconet</h4>
            
            <h4 data-toc-skip class="date">2024-06-06</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/ptaconet/modisfast/blob/HEAD/vignettes/use_case.Rmd" class="external-link"><code>vignettes/use_case.Rmd</code></a></small>
      <div class="hidden name"><code>use_case.Rmd</code></div>

    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>In this use case, we showcase how, starting with a simple table
containing sampling-like information (geographical coordinates and
dates), it is possible to retrieve meteorological or environmental data
around each of these sampling points at chosen lags before the sampling
dates.</p>
<p>Here, let’s say that we have a dataset containing abundances of
mosquitoes vectors of malaria. These mosquitoes were periodically
collected in several villages of a region of Northern Côte d’Ivoire
during 1.5 years. In total, 8 entomological surveys took place in 32
villages of this area. In order to analyse the effects of temperature
and rainfall on the abundance of these mosquitoes, we want to get the
average temperature and cumulated rainfall for each collection point, in
a 2-km radius buffer zone, one month before each collection date.</p>
<p><em>For information, the full ‘real’ dataset was <a href="https://doi.org/10.15468/V8FVYN" class="external-link">published in the GBIF</a> and
exhaustively described in <a href="https://doi.org/10.46471/gigabyte.83" class="external-link">this data
paper</a>).</em></p>
</div>
<div class="section level2">
<h2 id="set-up-the-parameters">Set-up the parameters<a class="anchor" aria-label="anchor" href="#set-up-the-parameters"></a>
</h2>
<p>First we load the useful packages :</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/ptaconet/modisfast" class="external-link">modisfast</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/" class="external-link">sf</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://rspatial.org/" class="external-link">terra</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://purrr.tidyverse.org/" class="external-link">purrr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span></code></pre></div>
<p>Then, let’s load the data and have a look at them :</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rspatial.github.io/terra/reference/headtail.html" class="external-link">head</a></span><span class="op">(</span><span class="va">entomological_data</span><span class="op">)</span></span>
<span><span class="co">#&gt;   mission       date village         X        Y   n</span></span>
<span><span class="co">#&gt; 1       1 2016-09-21     GUE -5.548970 9.271823 120</span></span>
<span><span class="co">#&gt; 2       1 2016-09-21     LOK -5.605484 9.186781 156</span></span>
<span><span class="co">#&gt; 3       1 2016-09-21     PEN -5.514849 9.253527  84</span></span>
<span><span class="co">#&gt; 4       1 2016-09-22     KOL -5.524137 9.288387 131</span></span>
<span><span class="co">#&gt; 5       1 2016-09-23     KAG -5.535555 9.282149 165</span></span>
<span><span class="co">#&gt; 6       1 2016-09-23     NOK -5.614132 9.251798 188</span></span></code></pre></div>
<ul>
<li>‘mission’ is the number of the entomological survey,</li>
<li>‘date’ is the date of the survey</li>
<li>‘village’ is a 3-digit code for the village of the survey</li>
<li>‘X’ and ‘Y’ are longitude and latitude of the center of the
village</li>
<li>‘n’ is the number of mosquitoes collected</li>
</ul>
<p>The first step is to convert this dataset as an <code>sf</code> POINT
object, and then generate its bounding box (ie. area of interest) to get
a POLYGON object (which is the input type for <code>modisfast</code>)
:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">entomological_data</span> <span class="op">&lt;-</span> <span class="va">entomological_data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html" class="external-link">st_as_sf</a></span><span class="op">(</span>coords <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"X"</span>, <span class="st">"Y"</span><span class="op">)</span>, crs <span class="op">=</span> <span class="fl">4326</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>date <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="va">date</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">roi</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_bbox.html" class="external-link">st_bbox</a></span><span class="op">(</span><span class="va">entomological_data</span><span class="op">)</span></span></code></pre></div>
<p>Since we will calculate the meteorological indicators in 2-km radius
buffer zones, we need to enlarge a bit the ROI. Here, we enlarge it by
3000 m in all directions (N, S, W, E) and we give the ROI the name
“Korhogo” (the name of the main city in the area) :</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># function expand_bbox() (Thanks @Chrisjb for the function)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/source.html" class="external-link">source</a></span><span class="op">(</span><span class="st">"https://raw.githubusercontent.com/Chrisjb/basemapR/master/R/expand_bbox.R"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">roi</span> <span class="op">&lt;-</span> <span class="va">roi</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">expand_bbox</span><span class="op">(</span><span class="va">.</span>,<span class="fl">3000</span>,<span class="fl">3000</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sfc.html" class="external-link">st_as_sfc</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/sf.html" class="external-link">st_sf</a></span><span class="op">(</span><span class="op">)</span> </span>
<span></span>
<span><span class="va">roi</span><span class="op">$</span><span class="va">id</span> <span class="op">=</span> <span class="st">"korhogo"</span></span></code></pre></div>
<p>Next, we define the time range of interest.</p>
<p>Here we will first download the whole time series, and then (in step
<a href="#extract-data">3</a>) filter-out the specific dates for each
collection point in the next step. So for download, we set the time
range as the period going from 30 days before the first collection date
to the last collection date.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">time_range</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">entomological_data</span><span class="op">$</span><span class="va">date</span><span class="op">)</span> <span class="op">-</span> <span class="fl">30</span>, <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">entomological_data</span><span class="op">$</span><span class="va">date</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">time_range</span></span>
<span><span class="co">#&gt; [1] "2016-08-22" "2018-04-03"</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="download-the-meteorological-data-using-modisfast">Download the meteorological data using <code>modisfast</code><a class="anchor" aria-label="anchor" href="#download-the-meteorological-data-using-modisfast"></a>
</h2>
<p>We now download the data using <code>modisfast</code> :</p>
<ul>
<li>“MOD11A2.061” = MODIS/Terra Land Surface Temperature/Emissivity
8-Day L3 Global 1 km SIN Grid v061</li>
<li>“GPM_3IMERGDF.07” = GPM IMERG Final Precipitation L3 1 day 0.1
degree x 0.1 degree V07</li>
</ul>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">log</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mf_login.html">mf_login</a></span><span class="op">(</span>credentials <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Sys.getenv.html" class="external-link">Sys.getenv</a></span><span class="op">(</span><span class="st">"earthdata_un"</span><span class="op">)</span>,<span class="fu"><a href="https://rdrr.io/r/base/Sys.getenv.html" class="external-link">Sys.getenv</a></span><span class="op">(</span><span class="st">"earthdata_pw"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Checking credentials...</span></span>
<span><span class="co">#&gt; Successfull login to earthdata</span></span>
<span></span>
<span><span class="va">urls_mod11a2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mf_get_url.html">mf_get_url</a></span><span class="op">(</span></span>
<span>  collection <span class="op">=</span> <span class="st">"MOD11A2.061"</span>,</span>
<span>  variables <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"LST_Day_1km"</span>,<span class="st">"LST_Night_1km"</span><span class="op">)</span>,</span>
<span>  roi <span class="op">=</span> <span class="va">roi</span>,</span>
<span>  time_range <span class="op">=</span> <span class="va">time_range</span> <span class="op">)</span></span>
<span><span class="co">#&gt; Building the URLs...</span></span>
<span><span class="co">#&gt; OK</span></span>
<span></span>
<span></span>
<span><span class="va">urls_gpm</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mf_get_url.html">mf_get_url</a></span><span class="op">(</span></span>
<span>  collection <span class="op">=</span> <span class="st">"GPM_3IMERGDF.07"</span>,</span>
<span>  variables <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"precipitation"</span><span class="op">)</span>, </span>
<span>  roi <span class="op">=</span> <span class="va">roi</span>,</span>
<span>  time_range <span class="op">=</span> <span class="va">time_range</span> <span class="op">)</span></span>
<span><span class="co">#&gt; Building the URLs...</span></span>
<span><span class="co">#&gt; OK</span></span>
<span></span>
<span></span>
<span><span class="va">res_dl_modis</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mf_download_data.html">mf_download_data</a></span><span class="op">(</span><span class="va">urls_mod11a2</span>, path <span class="op">=</span> <span class="st">"data_use_case"</span><span class="op">)</span></span>
<span><span class="co">#&gt; 1  datasets in total :  1  already downloaded and  0  datasets to download</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Data were all properly downloaded under the folder(s)  data_use_case/korhogo/MOD11A2.061</span></span>
<span><span class="va">res_dl_gpm</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mf_download_data.html">mf_download_data</a></span><span class="op">(</span><span class="va">urls_gpm</span>, path <span class="op">=</span> <span class="st">"data_use_case"</span><span class="op">)</span></span>
<span><span class="co">#&gt; 590  datasets in total :  590  already downloaded and  0  datasets to download</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Data were all properly downloaded under the folder(s)  data_use_case/korhogo/GPM_3IMERGDF.07</span></span></code></pre></div>
<p>And then we import it in R :</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># import MODIS</span></span>
<span><span class="va">modis_ts</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mf_import_data.html">mf_import_data</a></span><span class="op">(</span>path <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/basename.html" class="external-link">dirname</a></span><span class="op">(</span><span class="va">res_dl_modis</span><span class="op">$</span><span class="va">destfile</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span>, </span>
<span>                           collection_source <span class="op">=</span> <span class="st">"MODIS"</span><span class="op">)</span></span>
<span><span class="co"># import GPM</span></span>
<span><span class="va">gpm_ts</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mf_import_data.html">mf_import_data</a></span><span class="op">(</span>path <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/basename.html" class="external-link">dirname</a></span><span class="op">(</span><span class="va">res_dl_gpm</span><span class="op">$</span><span class="va">destfile</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span>, </span>
<span>                         collection_source <span class="op">=</span> <span class="st">"GPM"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">modis_ts</span><span class="op">)</span></span></code></pre></div>
<p><img src="use_case_files/figure-html/unnamed-chunk-7-1.png" width="700"></p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">gpm_ts</span><span class="op">)</span></span></code></pre></div>
<p><img src="use_case_files/figure-html/unnamed-chunk-7-2.png" width="700"></p>
<p>Our time series are here, let’s finish the job now !</p>
</div>
<div class="section level2">
<h2 id="extract-data">Extract the data in 2-km radius buffer areas and 1 month before each
collection date<a class="anchor" aria-label="anchor" href="#extract-data"></a>
</h2>
<p>The last step is to extract the average temperature and cumulated
rainfall for each collection point in a 2-km radius buffer zone, one
month before each collection date.</p>
<p>Below is some code for this - but feel free to adapt it, there are
many ways of doing this, and the code suggested here may not be the best
suited to your needs.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># generate a 2-km radius buffer area around each collection point</span></span>
<span><span class="va">sp_buffer</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_unary.html" class="external-link">st_buffer</a></span><span class="op">(</span><span class="va">entomological_data</span>, <span class="fl">2000</span><span class="op">)</span> </span>
<span></span>
<span><span class="co"># write a function that summarizes the data, given as input : </span></span>
<span><span class="co"># - a buffer zone (within which the data will we summarized),</span></span>
<span><span class="co"># - a SpatRaster time series, </span></span>
<span><span class="co"># - a layer of interest for this SpatRaster, </span></span>
<span><span class="co"># - a time range of interest</span></span>
<span><span class="co"># - a function to summarize the data for the considered time frame</span></span>
<span></span>
<span><span class="va">fun_get_zonal_stat</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">sp_buffer</span>, <span class="va">raster_ts</span>, <span class="va">variable</span>, <span class="va">min_date</span>, <span class="va">max_date</span>, <span class="va">fun_summarize</span><span class="op">)</span><span class="op">{</span></span>
<span>  </span>
<span>  <span class="va">r_sub</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">raster_ts</span>, <span class="fu"><a href="https://rspatial.github.io/terra/reference/time.html" class="external-link">time</a></span><span class="op">(</span><span class="va">raster_ts</span><span class="op">)</span> <span class="op">&gt;=</span> <span class="va">min_date</span> <span class="op">&amp;</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/time.html" class="external-link">time</a></span><span class="op">(</span><span class="va">raster_ts</span><span class="op">)</span> <span class="op">&lt;=</span> <span class="va">max_date</span><span class="op">)</span></span>
<span>  <span class="va">r_agg</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/app.html" class="external-link">app</a></span><span class="op">(</span><span class="va">r_sub</span><span class="op">[</span><span class="va">variable</span><span class="op">]</span>, <span class="va">fun_summarize</span>, na.rm <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span>
<span>  <span class="va">val</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/extract.html" class="external-link">extract</a></span><span class="op">(</span><span class="va">r_agg</span>, <span class="va">sp_buffer</span>, fun <span class="op">=</span> <span class="va">mean</span>, ID <span class="op">=</span> <span class="cn">F</span>, touches<span class="op">=</span><span class="cn">TRUE</span>, na.rm <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span>
<span>  <span class="va">val</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">val</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">val</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># split the dataset (needed for the execution of the function)</span></span>
<span><span class="va">sp_buffer_split</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/split.html" class="external-link">split</a></span><span class="op">(</span><span class="va">sp_buffer</span>, <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/dimensions.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">sp_buffer</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> </span>
<span></span>
<span><span class="co"># execute the function to get vectors</span></span>
<span><span class="va">LST_1_month_bef</span> <span class="op">&lt;-</span> <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map_dbl</a></span><span class="op">(</span><span class="va">sp_buffer_split</span>, <span class="op">~</span><span class="fu">fun_get_zonal_stat</span><span class="op">(</span><span class="va">.</span>, <span class="va">modis_ts</span>, <span class="st">"LST_Day_1km"</span>, <span class="va">.</span><span class="op">$</span><span class="va">date</span> <span class="op">-</span> <span class="fl">30</span>, <span class="va">.</span><span class="op">$</span><span class="va">date</span>, <span class="st">"mean"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">rain_1_month_bef</span> <span class="op">&lt;-</span> <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map_dbl</a></span><span class="op">(</span><span class="va">sp_buffer_split</span>, <span class="op">~</span><span class="fu">fun_get_zonal_stat</span><span class="op">(</span><span class="va">.</span>, <span class="va">gpm_ts</span>, <span class="st">"precipitation"</span>, <span class="va">.</span><span class="op">$</span><span class="va">date</span> <span class="op">-</span> <span class="fl">30</span>, <span class="va">.</span><span class="op">$</span><span class="va">date</span>, <span class="st">"sum"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># add columns in the original table (entomological_data) containing the extracted temperature and rainfall data</span></span>
<span><span class="va">entomological_data</span><span class="op">$</span><span class="va">LST_1_month_bef</span> <span class="op">&lt;-</span> <span class="va">LST_1_month_bef</span> <span class="op">-</span> <span class="fl">273.15</span>  <span class="co"># the - 273.15  is to convert the temperature from kelvin to °C</span></span>
<span><span class="va">entomological_data</span><span class="op">$</span><span class="va">rain_1_month_bef</span> <span class="op">&lt;-</span> <span class="va">rain_1_month_bef</span></span>
<span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/headtail.html" class="external-link">head</a></span><span class="op">(</span><span class="va">entomological_data</span><span class="op">)</span></span>
<span><span class="co">#&gt; Simple feature collection with 6 features and 6 fields</span></span>
<span><span class="co">#&gt; Geometry type: POINT</span></span>
<span><span class="co">#&gt; Dimension:     XY</span></span>
<span><span class="co">#&gt; Bounding box:  xmin: -5.614132 ymin: 9.186781 xmax: -5.514849 ymax: 9.288387</span></span>
<span><span class="co">#&gt; Geodetic CRS:  WGS 84</span></span>
<span><span class="co">#&gt;   mission       date village   n                   geometry LST_1_month_bef</span></span>
<span><span class="co">#&gt; 1       1 2016-09-21     GUE 120  POINT (-5.54897 9.271823)        28.59190</span></span>
<span><span class="co">#&gt; 2       1 2016-09-21     LOK 156 POINT (-5.605484 9.186781)        27.31314</span></span>
<span><span class="co">#&gt; 3       1 2016-09-21     PEN  84 POINT (-5.514849 9.253527)        28.50162</span></span>
<span><span class="co">#&gt; 4       1 2016-09-22     KOL 131 POINT (-5.524137 9.288387)        26.71242</span></span>
<span><span class="co">#&gt; 5       1 2016-09-23     KAG 165 POINT (-5.535555 9.282149)        27.68345</span></span>
<span><span class="co">#&gt; 6       1 2016-09-23     NOK 188 POINT (-5.614132 9.251798)        29.66437</span></span>
<span><span class="co">#&gt;   rain_1_month_bef</span></span>
<span><span class="co">#&gt; 1         377.1600</span></span>
<span><span class="co">#&gt; 2         366.2787</span></span>
<span><span class="co">#&gt; 3         374.3600</span></span>
<span><span class="co">#&gt; 4         362.1925</span></span>
<span><span class="co">#&gt; 5         370.0350</span></span>
<span><span class="co">#&gt; 6         368.2850</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="visualize-the-association-between-the-meteorological-variables-and-the-abundance-of-mosquitoes">Visualize the association between the meteorological variables and
the abundance of mosquitoes<a class="anchor" aria-label="anchor" href="#visualize-the-association-between-the-meteorological-variables-and-the-abundance-of-mosquitoes"></a>
</h2>
<p>We can now visualize the data :</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># association between diurnal temperature and mosquito abundance</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">entomological_data</span>,<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">LST_1_month_bef</span>, y<span class="op">=</span><span class="va">n</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_smooth.html" class="external-link">geom_smooth</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x<span class="op">=</span><span class="st">"Average diurnal temperature\n1 month before collection"</span>, y <span class="op">=</span> <span class="st">"Number of mosquitoes collected"</span><span class="op">)</span> </span></code></pre></div>
<p><img src="use_case_files/figure-html/unnamed-chunk-9-1.png" width="700"></p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># association between rainfall and mosquito abundance</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">entomological_data</span>,<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">rain_1_month_bef</span>, y<span class="op">=</span><span class="va">n</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_smooth.html" class="external-link">geom_smooth</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x<span class="op">=</span><span class="st">"Cumulated rainfall\n1 month before collection"</span>, y <span class="op">=</span> <span class="st">"Number of mosquitoes collected"</span><span class="op">)</span> </span></code></pre></div>
<p><img src="use_case_files/figure-html/unnamed-chunk-9-2.png" width="700"></p>
<p>We see that overall, there is :</p>
<ul>
<li>a negative relationship between diurnal temperature and mosquito
abundance (which makes sense : excessive temperatures might kill
mosquitoes)</li>
<li>a positive relationship between rainfall and mosquito abundance
(which makes sense too : rainfall creates puddles, which are breeding
sites)</li>
</ul>
<p>There also seem to be non-linear relationships that could be further
explored and explained.</p>
</div>
<div class="section level2">
<h2 id="next-steps-in-the-analyses-of-the-data">Next steps in the analyses of the data<a class="anchor" aria-label="anchor" href="#next-steps-in-the-analyses-of-the-data"></a>
</h2>
<p>Next steps could imply modeling the abundances of mosquitoes using
these meteorological data, for explanation or prediction purposes. To go
deeper, we could also extract data from more time frames, to better
apprehend several aspects of the ecology of the vectors in the study
area (eg. impact of meteorological variables at the different life
stages of the mosquitoes).</p>
<p>You may see <a href="https://doi.org/10.1186/s13071-021-04851-x" class="external-link">this
paper</a> and <a href="https://doi.org/10.31730/osf.io/jzxdw" class="external-link">this
one</a> for examples of full data mining works using such data.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Paul Taconet.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.9.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
